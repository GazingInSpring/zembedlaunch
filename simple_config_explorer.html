<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>zembed-1 configuration</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{
    font-family:'Inter',system-ui,sans-serif;
    background:#fafafa;
    color:#111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.5;
}

.page{max-width:820px;margin:0 auto;padding:48px 24px 80px}

/* ── Breadcrumb trail ── */
.trail{
    min-height:20px;
    margin-bottom:24px;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
}
.crumb{
    font-size:12px;
    font-weight:500;
    color:#666;
    letter-spacing:0.01em;
}
.crumb-sep{
    font-size:10px;
    color:#ccc;
    margin:0 2px;
}
.crumb-val{color:#111;font-weight:600}

/* ── Step (single visible at a time) ── */
.step-container{
    position:relative;
    overflow:hidden;
    min-height:120px;
}
.step{
    position:absolute;
    top:0;left:0;right:0;
    opacity:0;
    transform:translateX(40px);
    transition:opacity .3s ease-out,transform .3s ease-out;
    pointer-events:none;
}
.step.active{
    position:relative;
    opacity:1;
    transform:translateX(0);
    pointer-events:auto;
}
.step.exiting{
    opacity:0;
    transform:translateX(-40px);
}
.step-q{
    font-size:17px;
    font-weight:600;
    color:#111;
    margin-bottom:16px;
    letter-spacing:-0.01em;
}
.step-hint{
    font-size:12px;
    color:#999;
    margin-bottom:16px;
}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{
    padding:8px 20px;
    border:1px solid #ddd;
    border-radius:6px;
    font-size:13px;
    font-weight:500;
    font-family:inherit;
    background:#fff;
    color:#333;
    cursor:pointer;
    transition:border-color .15s,background .15s,color .15s;
    line-height:1.4;
    user-select:none;
}
.pill:hover{border-color:#999;background:#f5f5f5}
.pill.selected{
    border-color:#4f46e5;
    background:#4f46e5;
    color:#fff;
}

/* ── Recommendation ── */
.reco{
    margin-top:40px;
    padding:24px 0;
    border-top:1px solid #e5e5e5;
    opacity:0;
    transform:translateY(8px);
    transition:opacity .35s ease-out,transform .35s ease-out;
    pointer-events:none;
}
.reco.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.reco-label{
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:#4f46e5;
    margin-bottom:8px;
}
.reco-name{
    font-size:22px;
    font-weight:700;
    letter-spacing:-0.02em;
    margin-bottom:2px;
}
.reco-desc{font-size:13px;color:#666;margin-bottom:20px}
.reco-stats{display:flex;gap:40px;flex-wrap:wrap}
.reco-stat-val{
    font-size:20px;
    font-weight:700;
    font-family:'JetBrains Mono','SF Mono',monospace;
    letter-spacing:-0.02em;
}
.reco-stat-label{
    font-size:11px;
    color:#999;
    font-weight:500;
    letter-spacing:0.02em;
}

/* ── Reset ── */
.reset-row{
    margin-top:20px;
    opacity:0;
    transition:opacity .3s;
    pointer-events:none;
}
.reset-row.visible{opacity:1;pointer-events:auto}
.reset-link{
    font-size:12px;
    color:#999;
    cursor:pointer;
    text-decoration:none;
    font-weight:500;
    border:none;
    background:none;
    font-family:inherit;
    padding:0;
}
.reset-link:hover{color:#4f46e5}

/* ── Table ── */
.results{
    margin-top:32px;
    opacity:0;
    transform:translateY(10px);
    transition:opacity .4s ease-out .1s,transform .4s ease-out .1s;
    pointer-events:none;
}
.results.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.tbl{width:100%;border-collapse:collapse}
.tbl thead th{
    text-align:left;
    padding:8px 10px;
    font-size:10px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.06em;
    color:#aaa;
    border-bottom:1px solid #e5e5e5;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
}
.tbl thead th:hover{color:#4f46e5}
.tbl thead th.r{text-align:right}
.tbl tbody td{
    padding:10px 10px;
    font-size:13px;
    border-bottom:1px solid #f0f0f0;
    transition:background .2s;
}
.tbl tbody td.r{
    text-align:right;
    font-family:'JetBrains Mono','SF Mono',monospace;
    font-size:12px;
    font-variant-numeric:tabular-nums;
}
.tbl tbody tr{transition:background .2s}
.tbl tbody tr:hover{background:#f8f8f8}
.tbl tbody tr.is-reco{border-left:3px solid #4f46e5;background:#f9f8ff}
.tbl tbody tr.is-reco:hover{background:#f3f1ff}

/* ── Scatter ── */
.scatter-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
    margin-bottom:24px;
}
.scatter-wrap{
    height:260px;
    background:#fff;
    border:1px solid #eee;
    border-radius:8px;
    padding:12px;
}
.scatter-wrap canvas{max-height:236px}

@media(max-width:640px){
    .scatter-row{display:none}
    .reco-stats{gap:24px}
}
</style>
</head>
<body>
<div class="page">

<div class="trail" id="trail"></div>
<div class="step-container" id="stepContainer"></div>

<div class="reco" id="reco">
    <div class="reco-label">Recommended</div>
    <div class="reco-name" id="recoName"></div>
    <div class="reco-desc" id="recoDesc"></div>
    <div class="reco-stats">
        <div><div class="reco-stat-val" id="recoAcc"></div><div class="reco-stat-label">Recall@10</div></div>
        <div><div class="reco-stat-val" id="recoLat"></div><div class="reco-stat-label">Latency</div></div>
        <div><div class="reco-stat-val" id="recoDims"></div><div class="reco-stat-label">Dimensions</div></div>
        <div><div class="reco-stat-val" id="recoStor"></div><div class="reco-stat-label">per 1M docs</div></div>
    </div>
</div>

<div class="reset-row" id="resetRow">
    <button class="reset-link" onclick="reset()">Start over</button>
</div>

<div class="results" id="results">
    <div class="scatter-row">
        <div class="scatter-wrap"><canvas id="sc1"></canvas></div>
        <div class="scatter-wrap"><canvas id="sc2"></canvas></div>
    </div>
    <table class="tbl" id="tbl">
        <thead><tr>
            <th data-col="name">Configuration</th>
            <th data-col="dims" class="r">Dims</th>
            <th data-col="quantization">Quant</th>
            <th data-col="storageBytes" class="r">Storage</th>
            <th data-col="latency_ms" class="r">Latency</th>
            <th data-col="accuracy" class="r">Recall@10</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
const CONFIGS = [{"id": "zembed-1-f32-full", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half", "name": "zembed-1 (half dim)", "quantization": "float32", "matryoshka": "half", "dims": 1024, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#4f46e5"}, {"id": "zembed-1-f32-quarter", "name": "zembed-1 (quarter dim)", "quantization": "float32", "matryoshka": "quarter", "dims": 512, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.04, "color": "#4f46e5"}, {"id": "zembed-1-f32-eighth", "name": "zembed-1 (eighth dim)", "quantization": "float32", "matryoshka": "eighth", "dims": 256, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.08, "color": "#4f46e5"}, {"id": "zembed-1-int8-full", "name": "zembed-1 (int8)", "quantization": "int8", "matryoshka": "full", "dims": 2048, "bits_per_dim": 8, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.005, "color": "#4f46e5"}, {"id": "zembed-1-int8-half", "name": "zembed-1 (int8, half dim)", "quantization": "int8", "matryoshka": "half", "dims": 1024, "bits_per_dim": 8, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.02, "color": "#4f46e5"}, {"id": "zembed-1-bin-full", "name": "zembed-1 (binary)", "quantization": "binary", "matryoshka": "full", "dims": 2048, "bits_per_dim": 1, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.025, "color": "#4f46e5"}, {"id": "zembed-1-bin-half", "name": "zembed-1 (binary, half dim)", "quantization": "binary", "matryoshka": "half", "dims": 1024, "bits_per_dim": 1, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.035, "color": "#4f46e5"}, {"id": "zembed-1-f32-full-vpc-a10g", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half-vpc-a10g", "name": "zembed-1 (half dim)", "quantization": "float32", "matryoshka": "half", "dims": 1024, "bits_per_dim": 32, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#4f46e5"}, {"id": "zembed-1-int8-full-vpc-a10g", "name": "zembed-1 (int8)", "quantization": "int8", "matryoshka": "full", "dims": 2048, "bits_per_dim": 8, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.005, "color": "#4f46e5"}, {"id": "zembed-1-bin-half-vpc-a10g", "name": "zembed-1 (binary, half dim)", "quantization": "binary", "matryoshka": "half", "dims": 1024, "bits_per_dim": 1, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.035, "color": "#4f46e5"}, {"id": "zembed-1-f32-full-vpc-h100", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "vpc", "gpu": "H100", "price_per_hour": 4.5, "max_tokens_per_sec": 200000, "latency_ms": 15, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half-vpc-h100", "name": "zembed-1 (half dim)", "quantization": "float32", "matryoshka": "half", "dims": 1024, "bits_per_dim": 32, "deployment": "vpc", "gpu": "H100", "price_per_hour": 4.5, "max_tokens_per_sec": 200000, "latency_ms": 15, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#4f46e5"}];
const CURVES = {"zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450": [0.07432, 0.11991, 0.1569, 0.19005, 0.21845, 0.24193, 0.26247, 0.28404, 0.30216, 0.31819, 0.33332, 0.34752, 0.36052, 0.37331, 0.38536, 0.39702, 0.40796, 0.41847, 0.42833, 0.4374, 0.4479, 0.45637, 0.46471, 0.47143, 0.47803, 0.48402, 0.49008, 0.49667, 0.50337, 0.50871, 0.51507, 0.52131, 0.52687, 0.53186, 0.53832, 0.54176, 0.54536, 0.55015, 0.55422, 0.55769, 0.56234, 0.56601, 0.56899, 0.57305, 0.57638, 0.57968, 0.58341, 0.58704, 0.59036, 0.59458, 0.59732, 0.60027, 0.60448, 0.60725, 0.61031, 0.61334, 0.61672, 0.62019, 0.62271, 0.62524, 0.62819, 0.63077, 0.63301, 0.63549, 0.63795, 0.64024, 0.64206, 0.6436, 0.64531, 0.64818, 0.65018, 0.65234, 0.65427, 0.65595, 0.65747, 0.65979, 0.66166, 0.66461, 0.66738, 0.66866, 0.67068, 0.67294, 0.67469, 0.6771, 0.67861, 0.68072, 0.68259, 0.68388, 0.68593, 0.68765, 0.68891, 0.69072, 0.69256, 0.69438, 0.69589, 0.69717, 0.69945, 0.70065, 0.70205, 0.70387], "aimodel-embed/modal/voyage-4.zeroentropy.dev": [0.06552, 0.11047, 0.14713, 0.18214, 0.20847, 0.23352, 0.25545, 0.2778, 0.29755, 0.31541, 0.32955, 0.34344, 0.35488, 0.36702, 0.37848, 0.39, 0.40018, 0.40934, 0.41965, 0.42886, 0.43897, 0.44618, 0.45463, 0.46125, 0.46798, 0.47533, 0.48293, 0.48993, 0.49608, 0.50216, 0.50766, 0.51377, 0.52007, 0.52517, 0.53137, 0.53619, 0.54022, 0.54494, 0.54906, 0.5528, 0.55736, 0.5612, 0.56616, 0.5701, 0.57319, 0.57766, 0.58194, 0.58574, 0.59177, 0.59533, 0.59867, 0.60195, 0.60465, 0.60751, 0.61154, 0.61501, 0.61792, 0.62049, 0.62411, 0.6268, 0.6292, 0.63243, 0.63432, 0.6368, 0.63982, 0.64254, 0.64516, 0.64723, 0.64925, 0.65141, 0.65371, 0.656, 0.65809, 0.65968, 0.66295, 0.66578, 0.66791, 0.66902, 0.67123, 0.67341, 0.67512, 0.67726, 0.68011, 0.68163, 0.68394, 0.68651, 0.68814, 0.69062, 0.69271, 0.69406, 0.69685, 0.69851, 0.69988, 0.70073, 0.7023, 0.70358, 0.70509, 0.70688, 0.7086, 0.70976], "aimodel-embed/modal/zeroentropy--voyage-4-nano-model-endpoint.modal.run": [0.05638, 0.09675, 0.13112, 0.16021, 0.18599, 0.20369, 0.22397, 0.24121, 0.26075, 0.27791, 0.29193, 0.30417, 0.31532, 0.32813, 0.33751, 0.34837, 0.35963, 0.3692, 0.38091, 0.38854, 0.39687, 0.40569, 0.41239, 0.41897, 0.42692, 0.43429, 0.44101, 0.44728, 0.45281, 0.45875, 0.46393, 0.46922, 0.47464, 0.47979, 0.48357, 0.48772, 0.49389, 0.498, 0.50268, 0.50669, 0.51034, 0.51408, 0.51922, 0.52304, 0.52699, 0.53137, 0.53465, 0.53838, 0.54269, 0.54611, 0.5487, 0.55218, 0.55426, 0.55698, 0.55997, 0.56265, 0.5655, 0.56886, 0.57079, 0.57336, 0.5768, 0.57969, 0.58215, 0.58493, 0.58872, 0.59067, 0.59376, 0.59665, 0.59907, 0.60187, 0.60401, 0.60618, 0.60878, 0.61073, 0.61288, 0.615, 0.61718, 0.62007, 0.62258, 0.62486, 0.62695, 0.62867, 0.63128, 0.63338, 0.63581, 0.63738, 0.63931, 0.64115, 0.64202, 0.64346, 0.64533, 0.64695, 0.64859, 0.65007, 0.65156, 0.65318, 0.65467, 0.6567, 0.65802, 0.65975], "aimodel-embed/openai/text-embedding-3-large": [0.05532, 0.09518, 0.129, 0.15517, 0.1812, 0.20393, 0.22331, 0.24021, 0.25679, 0.27221, 0.2849, 0.29719, 0.31016, 0.32124, 0.33188, 0.34084, 0.35038, 0.36152, 0.37167, 0.38108, 0.38965, 0.39687, 0.40391, 0.41159, 0.41788, 0.42556, 0.432, 0.43706, 0.44259, 0.44823, 0.45396, 0.46013, 0.46462, 0.47109, 0.47491, 0.48086, 0.48476, 0.48911, 0.49337, 0.49779, 0.50228, 0.50722, 0.51235, 0.5163, 0.5192, 0.52309, 0.52665, 0.53082, 0.53506, 0.5378, 0.54171, 0.54441, 0.54807, 0.55063, 0.55318, 0.55619, 0.5592, 0.56154, 0.56499, 0.5676, 0.57099, 0.57377, 0.57674, 0.57922, 0.58205, 0.58475, 0.58774, 0.5903, 0.59217, 0.59511, 0.59705, 0.5992, 0.60046, 0.60352, 0.60581, 0.6074, 0.60917, 0.61086, 0.61327, 0.61494, 0.61659, 0.61822, 0.62041, 0.62221, 0.62411, 0.62659, 0.62851, 0.63038, 0.63262, 0.63453, 0.63577, 0.63698, 0.6384, 0.64056, 0.64211, 0.64338, 0.64418, 0.64555, 0.64762, 0.64892], "aimodel-embed/openai/text-embedding-3-small": [0.05151, 0.08477, 0.11496, 0.13818, 0.15794, 0.17541, 0.19028, 0.2078, 0.22551, 0.23862, 0.25051, 0.26262, 0.27486, 0.28456, 0.29497, 0.30403, 0.31223, 0.32165, 0.33063, 0.33895, 0.34642, 0.35292, 0.36058, 0.36648, 0.37338, 0.3785, 0.38443, 0.38978, 0.39519, 0.40102, 0.40625, 0.4118, 0.41791, 0.42192, 0.4269, 0.43143, 0.43509, 0.44027, 0.44571, 0.44948, 0.4536, 0.45679, 0.46053, 0.46442, 0.46803, 0.47084, 0.47447, 0.47794, 0.48129, 0.48477, 0.48774, 0.49114, 0.49541, 0.49827, 0.50135, 0.50404, 0.50718, 0.50942, 0.51144, 0.51341, 0.51588, 0.51775, 0.51942, 0.52245, 0.52522, 0.52687, 0.52903, 0.53198, 0.53416, 0.5364, 0.53918, 0.54167, 0.54366, 0.54623, 0.54847, 0.5503, 0.55218, 0.55402, 0.5554, 0.55704, 0.55932, 0.56151, 0.56352, 0.56528, 0.56747, 0.56988, 0.57274, 0.57414, 0.57644, 0.57815, 0.57944, 0.58158, 0.5836, 0.58476, 0.58689, 0.58874, 0.59046, 0.59338, 0.59558, 0.59779]};
const RK = 10;

const STEPS = {
    deploy:  {q:'Where does it run?', choices:[
        {val:'api', label:'ZeroEntropy API'},
        {val:'vpc', label:'Private VPC'},
    ]},
    gpu:     {q:'Which GPU?', hint:'Determines throughput and per-hour cost.', choices:[
        {val:'A10G', label:'A10G'},
        {val:'H100', label:'H100'},
    ]},
    latency: {q:'Latency budget?', choices:[
        {val:'tight', label:'< 20 ms'},
        {val:'normal', label:'< 50 ms'},
        {val:'relaxed', label:'No constraint'},
    ]},
    storage: {q:'Storage priority?', choices:[
        {val:'min', label:'Minimize'},
        {val:'balanced', label:'Balanced'},
        {val:'max', label:'Max accuracy'},
    ]},
};

let answers = {};
let flow = [];
let flowIdx = 0;
let sortCol = 'accuracy', sortAsc = false;
let c1 = null, c2 = null;
let recoId = null;

function acc(c) {
    if (c.accuracy_override !== undefined) return c.accuracy_override;
    if (c.checkpoint && CURVES[c.checkpoint]) return Math.max(0, CURVES[c.checkpoint][RK-1] - (c.accuracy_penalty||0));
    return 0;
}
function stor(c) { return 1e6 * c.dims * c.bits_per_dim / 8; }
function fmtB(b) {
    const g = b / 1073741824;
    return g >= 1000 ? (g/1000).toFixed(1)+' TB' : g >= 1 ? g.toFixed(1)+' GB' : (g*1024).toFixed(0)+' MB';
}

function buildFlow() {
    flow = ['deploy'];
    if (answers.deploy === 'vpc') flow.push('gpu');
    flow.push('latency', 'storage');
}

function renderTrail() {
    const el = document.getElementById('trail');
    let html = '';
    for (let i = 0; i < flowIdx; i++) {
        const key = flow[i];
        const choice = STEPS[key].choices.find(c => c.val === answers[key]);
        if (i > 0) html += '<span class="crumb-sep">/</span>';
        html += '<span class="crumb"><span class="crumb-val">' + (choice ? choice.label : '') + '</span></span>';
    }
    el.innerHTML = html;
}

function renderStep() {
    const container = document.getElementById('stepContainer');
    const prev = container.querySelector('.step.active');

    if (flowIdx >= flow.length) {
        if (prev) { prev.classList.add('exiting'); prev.classList.remove('active'); setTimeout(() => prev.remove(), 300); }
        resolve();
        return;
    }

    const key = flow[flowIdx];
    const step = STEPS[key];
    const div = document.createElement('div');
    div.className = 'step';
    let html = '<div class="step-q">' + step.q + '</div>';
    if (step.hint) html += '<div class="step-hint">' + step.hint + '</div>';
    html += '<div class="pills">';
    for (const ch of step.choices) {
        html += '<button class="pill" data-key="' + key + '" data-val="' + ch.val + '">' + ch.label + '</button>';
    }
    html += '</div>';
    div.innerHTML = html;
    container.appendChild(div);

    div.querySelectorAll('.pill').forEach(btn => {
        btn.addEventListener('click', () => pick(btn.dataset.key, btn.dataset.val, btn));
    });

    if (prev) {
        prev.classList.add('exiting');
        prev.classList.remove('active');
        setTimeout(() => prev.remove(), 300);
    }
    requestAnimationFrame(() => requestAnimationFrame(() => div.classList.add('active')));
}

function pick(key, val, btn) {
    answers[key] = val;
    btn.parentElement.querySelectorAll('.pill').forEach(p => p.classList.remove('selected'));
    btn.classList.add('selected');

    setTimeout(() => {
        buildFlow();
        flowIdx = flow.indexOf(key) + 1;
        renderTrail();
        renderStep();
    }, 150);
}

function filtered() {
    return CONFIGS.filter(c => {
        if (answers.deploy === 'api' && c.deployment !== 'api') return false;
        if (answers.deploy === 'vpc' && c.deployment !== 'vpc') return false;
        if (answers.deploy === 'vpc' && answers.gpu && c.gpu !== answers.gpu) return false;
        return true;
    }).map(c => ({...c, accuracy: acc(c), storageBytes: stor(c)}));
}

function meetsLat(c) {
    if (answers.latency === 'tight') return c.latency_ms < 20;
    if (answers.latency === 'normal') return c.latency_ms < 50;
    return true;
}

function resolve() {
    const all = filtered();
    const eligible = all.filter(meetsLat);
    const pool = eligible.length > 0 ? eligible : all;

    if (answers.storage === 'min') pool.sort((a,b) => a.storageBytes - b.storageBytes || b.accuracy - a.accuracy);
    else if (answers.storage === 'max') pool.sort((a,b) => b.accuracy - a.accuracy);
    else pool.sort((a,b) => (b.accuracy - b.storageBytes/1e13) - (a.accuracy - a.storageBytes/1e13));

    const best = pool[0];
    recoId = best.id;

    const qd = best.quantization === 'float32' ? 'Full precision' : best.quantization === 'int8' ? '8-bit quantized' : 'Binary quantized';
    const dd = best.deployment === 'api' ? 'ZeroEntropy API' : best.gpu + ' VPC';
    document.getElementById('recoName').textContent = best.name;
    document.getElementById('recoDesc').textContent = qd + ', ' + best.dims + ' dimensions, ' + dd;
    document.getElementById('recoAcc').textContent = (best.accuracy * 100).toFixed(1) + '%';
    document.getElementById('recoLat').textContent = best.latency_ms + ' ms';
    document.getElementById('recoDims').textContent = String(best.dims);
    document.getElementById('recoStor').textContent = fmtB(best.storageBytes);

    document.getElementById('reco').classList.add('visible');
    document.getElementById('resetRow').classList.add('visible');
    setTimeout(() => {
        document.getElementById('results').classList.add('visible');
        renderTable(all);
        renderScatter(all);
    }, 150);
}

function renderTable(rows) {
    const sorted = [...rows].sort((a,b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
        return sortAsc ? (va < vb ? -1 : 1) : (va > vb ? -1 : 1);
    });
    // Move reco to top
    const ri = sorted.findIndex(r => r.id === recoId);
    if (ri > 0) { const [r] = sorted.splice(ri, 1); sorted.unshift(r); }

    let html = '';
    for (const r of sorted) {
        const cls = r.id === recoId ? 'is-reco' : '';
        html += '<tr class="'+cls+'">'
            + '<td>'+r.name+'</td>'
            + '<td class="r">'+r.dims+'</td>'
            + '<td>'+r.quantization+'</td>'
            + '<td class="r">'+fmtB(r.storageBytes)+'</td>'
            + '<td class="r">'+r.latency_ms+' ms</td>'
            + '<td class="r">'+(r.accuracy*100).toFixed(1)+'%</td>'
            + '</tr>';
    }
    document.getElementById('tbody').innerHTML = html;
}

function renderScatter(rows) {
    const DOT = '#bbb';
    const RECO = '#4f46e5';
    const pts = rows.map(r => ({
        sg: r.storageBytes / 1073741824,
        lat: r.latency_ms,
        y: r.accuracy,
        label: r.name + ' (' + r.quantization + ')',
        color: r.id === recoId ? RECO : DOT,
        r: r.id === recoId ? 8 : 5,
        bw: r.id === recoId ? 2.5 : 0,
        bc: r.id === recoId ? '#fff' : 'transparent',
    }));

    const mkOpts = (xLabel) => ({
        responsive:true, maintainAspectRatio:false,
        animation:{duration:400,easing:'easeOutCubic'},
        plugins:{legend:{display:false},tooltip:{callbacks:{
            label:(i) => { const p=pts[i.dataIndex]; return p.label+': '+(p.y*100).toFixed(1)+'%'; }
        }}},
        scales:{
            x:{title:{display:true,text:xLabel,font:{size:11,family:'Inter'}},grid:{color:'#f0f0f0'}},
            y:{title:{display:true,text:'Recall@10',font:{size:11,family:'Inter'}},min:0,max:1,grid:{color:'#f0f0f0'}},
        },
    });
    const mkDs = (xfn) => [{
        data:pts.map(p => ({x:xfn(p),y:p.y})),
        backgroundColor:pts.map(p=>p.color),
        pointRadius:pts.map(p=>p.r),
        pointBorderColor:pts.map(p=>p.bc),
        pointBorderWidth:pts.map(p=>p.bw),
    }];

    if(c1){c1.data.datasets=mkDs(p=>p.sg);c1.options=mkOpts('Storage / 1M docs (GB)');c1.update();}
    else c1=new Chart(document.getElementById('sc1'),{type:'scatter',data:{datasets:mkDs(p=>p.sg)},options:mkOpts('Storage / 1M docs (GB)')});

    if(c2){c2.data.datasets=mkDs(p=>p.lat);c2.options=mkOpts('Latency (ms)');c2.update();}
    else c2=new Chart(document.getElementById('sc2'),{type:'scatter',data:{datasets:mkDs(p=>p.lat)},options:mkOpts('Latency (ms)')});
}

function reset() {
    answers = {}; flow = []; flowIdx = 0; recoId = null;
    document.getElementById('reco').classList.remove('visible');
    document.getElementById('results').classList.remove('visible');
    document.getElementById('resetRow').classList.remove('visible');
    document.getElementById('trail').innerHTML = '';
    const container = document.getElementById('stepContainer');
    const prev = container.querySelector('.step');
    if (prev) { prev.classList.add('exiting'); prev.classList.remove('active'); setTimeout(() => prev.remove(), 300); }
    buildFlow();
    setTimeout(renderStep, 100);
}

document.querySelectorAll('#tbl thead th').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = col === 'name' || col === 'quantization'; }
        renderTable(filtered());
    });
});

buildFlow();
renderStep();
</script>
</body>
</html>