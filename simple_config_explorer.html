<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>zembed-1 ‚Äî Find Your Configuration</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f5f7;color:#1a1a1a;-webkit-font-smoothing:antialiased}
.page{max-width:900px;margin:0 auto;padding:40px 20px}

/* Wizard */
.wizard{margin-bottom:32px}
.step{background:#fff;border-radius:16px;border:1px solid #e5e5e5;box-shadow:0 4px 24px rgba(0,0,0,.05);padding:28px 32px;margin-bottom:20px;overflow:hidden;transition:opacity .3s,max-height .4s cubic-bezier(.4,0,.2,1),padding .4s,margin .4s,border-color .3s}
.step.collapsed{max-height:0;padding:0 32px;margin-bottom:0;border-color:transparent;opacity:0;pointer-events:none}
.step-num{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#4f46e5;margin-bottom:6px}
.step h2{font-size:20px;font-weight:700;letter-spacing:-.02em;margin-bottom:4px}
.step .desc{font-size:14px;color:#888;margin-bottom:20px;line-height:1.5}
.choices{display:flex;gap:12px;flex-wrap:wrap}
.choice{flex:1;min-width:140px;padding:16px 20px;border:2px solid #e5e5e5;border-radius:12px;cursor:pointer;transition:all .15s;text-align:center;user-select:none}
.choice:hover{border-color:#a5b4fc;background:#f8f7ff}
.choice.selected{border-color:#4f46e5;background:#ede9fe}
.choice .label{font-size:15px;font-weight:600;margin-bottom:2px}
.choice .sub{font-size:12px;color:#888}

/* Recommendation banner */
.reco{background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);border-radius:16px;padding:32px;color:#fff;margin-bottom:28px;opacity:0;transform:translateY(12px);transition:opacity .4s,transform .4s;pointer-events:none}
.reco.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.reco .reco-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.7;margin-bottom:8px}
.reco h2{font-size:28px;font-weight:800;letter-spacing:-.03em;margin-bottom:4px}
.reco .reco-sub{font-size:14px;opacity:.85;line-height:1.5}
.reco .reco-stats{display:flex;gap:32px;margin-top:20px;flex-wrap:wrap}
.reco .stat{text-align:center}
.reco .stat .val{font-size:24px;font-weight:800}
.reco .stat .stat-label{font-size:11px;text-transform:uppercase;letter-spacing:.5px;opacity:.7}

/* Results */
.results{opacity:0;transform:translateY(16px);transition:opacity .5s,transform .5s;pointer-events:none}
.results.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.card{background:#fff;border-radius:16px;border:1px solid #e5e5e5;box-shadow:0 4px 24px rgba(0,0,0,.05);padding:28px 32px;margin-bottom:24px}
.card h3{font-size:17px;font-weight:700;letter-spacing:-.01em;margin-bottom:4px}
.card .desc{font-size:13px;color:#888;margin-bottom:20px}
.scatter-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.scatter-box{position:relative;height:320px;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:14px}
.scatter-box canvas{max-height:280px}

/* Table */
.result-table{width:100%;border-collapse:collapse;font-size:13px}
.result-table thead th{text-align:left;padding:10px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#999;border-bottom:2px solid #eee;cursor:pointer;user-select:none;white-space:nowrap}
.result-table thead th:hover{color:#4f46e5}
.result-table thead th.num{text-align:right}
.result-table tbody td{padding:11px 12px;border-bottom:1px solid #f0f0f0;transition:background .3s}
.result-table tbody td.num{text-align:right;font-variant-numeric:tabular-nums;font-family:'SF Mono','Monaco',monospace;font-size:12px}
.result-table tbody tr{transition:background .3s,opacity .3s,transform .3s}
.result-table tbody tr:hover{background:#f8f8ff}
.result-table tbody tr.recommended{background:#ede9fe}
.result-table tbody tr.recommended:hover{background:#ddd6fe}
.result-table tbody tr.dimmed{opacity:.4}
.model-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;vertical-align:middle}
.tag{display:inline-block;font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;margin-left:6px}
.tag-best{background:#ecfdf5;color:#059669}
.tag-reco{background:#ede9fe;color:#4f46e5}

/* Reset button */
.reset-bar{text-align:center;margin-bottom:24px;opacity:0;transition:opacity .3s;pointer-events:none}
.reset-bar.visible{opacity:1;pointer-events:auto}
.reset-btn{padding:8px 24px;border:1px solid #ddd;border-radius:8px;font-size:13px;font-weight:600;font-family:inherit;background:#fff;cursor:pointer;transition:all .15s}
.reset-btn:hover{background:#f0f0f0;border-color:#bbb}

@media(max-width:640px){
.scatter-grid{grid-template-columns:1fr}
.choices{flex-direction:column}
.choice{min-width:0}
.reco .reco-stats{gap:16px}
}
</style>
</head>
<body>
<div class="page">
<div class="wizard" id="wizard">
    <div class="step" id="step-deploy">
        <div class="step-num">Step 1 of 3</div>
        <h2>How do you want to deploy?</h2>
        <p class="desc">Choose based on your security and infrastructure requirements.</p>
        <div class="choices">
            <div class="choice" onclick="pick('deploy','api')">
                <div class="label">‚òÅÔ∏è ZeroEntropy API</div>
                <div class="sub">Serverless ¬∑ pay per token</div>
            </div>
            <div class="choice" onclick="pick('deploy','vpc')">
                <div class="label">üîí Private VPC</div>
                <div class="sub">AWS / Azure ¬∑ your infrastructure</div>
            </div>
        </div>
    </div>

    <div class="step collapsed" id="step-gpu">
        <div class="step-num">Step 2 of 3</div>
        <h2>Which GPU?</h2>
        <p class="desc">Determines your throughput ceiling and per-hour cost.</p>
        <div class="choices">
            <div class="choice" onclick="pick('gpu','A10G')">
                <div class="label">A10G</div>
                <div class="sub">~$1.50/hr ¬∑ good throughput</div>
            </div>
            <div class="choice" onclick="pick('gpu','H100')">
                <div class="label">H100</div>
                <div class="sub">~$4.50/hr ¬∑ max throughput</div>
            </div>
        </div>
    </div>

    <div class="step collapsed" id="step-latency">
        <div class="step-num" id="latency-step-num">Step 2 of 3</div>
        <h2>What's your latency budget?</h2>
        <p class="desc">Maximum acceptable p50 embedding latency.</p>
        <div class="choices">
            <div class="choice" onclick="pick('latency','tight')">
                <div class="label">‚ö° &lt;20ms</div>
                <div class="sub">Real-time / autocomplete</div>
            </div>
            <div class="choice" onclick="pick('latency','normal')">
                <div class="label">üîÑ &lt;50ms</div>
                <div class="sub">Standard search</div>
            </div>
            <div class="choice" onclick="pick('latency','relaxed')">
                <div class="label">üê¢ Don't care</div>
                <div class="sub">Batch / offline</div>
            </div>
        </div>
    </div>

    <div class="step collapsed" id="step-storage">
        <div class="step-num" id="storage-step-num">Step 3 of 3</div>
        <h2>How much do you care about storage cost?</h2>
        <p class="desc">Smaller embeddings = less vector DB cost, slightly less accuracy.</p>
        <div class="choices">
            <div class="choice" onclick="pick('storage','min')">
                <div class="label">ü™∂ Minimize storage</div>
                <div class="sub">Binary quantization ¬∑ smallest footprint</div>
            </div>
            <div class="choice" onclick="pick('storage','balanced')">
                <div class="label">‚öñÔ∏è Balanced</div>
                <div class="sub">int8 or reduced dims</div>
            </div>
            <div class="choice" onclick="pick('storage','max')">
                <div class="label">üéØ Max accuracy</div>
                <div class="sub">Full float32 ¬∑ full dimensions</div>
            </div>
        </div>
    </div>
</div>

<div class="reco" id="reco">
    <div class="reco-label">Recommended Configuration</div>
    <h2 id="recoName"></h2>
    <div class="reco-sub" id="recoSub"></div>
    <div class="reco-stats">
        <div class="stat"><div class="val" id="recoAccuracy"></div><div class="stat-label">Recall@10</div></div>
        <div class="stat"><div class="val" id="recoLatency"></div><div class="stat-label">Latency</div></div>
        <div class="stat"><div class="val" id="recoDims"></div><div class="stat-label">Dimensions</div></div>
        <div class="stat"><div class="val" id="recoStorage"></div><div class="stat-label">Per 1M docs</div></div>
    </div>
</div>

<div class="reset-bar" id="resetBar">
    <button class="reset-btn" onclick="resetWizard()">‚Ü∫ Start over</button>
</div>
<div class="results" id="results">
    <div class="card">
        <h3>All Configurations</h3>
        <p class="desc">Sorted by accuracy. Recommended config highlighted. Click headers to re-sort.</p>
        <div class="scatter-grid" style="margin-bottom:24px">
            <div class="scatter-box"><canvas id="scatterStorageAcc"></canvas></div>
            <div class="scatter-box"><canvas id="scatterLatAcc"></canvas></div>
        </div>
        <div style="overflow-x:auto">
            <table class="result-table" id="resultTable">
                <thead><tr>
                    <th data-col="name">Configuration</th>
                    <th data-col="dims" class="num">Dims</th>
                    <th data-col="quantization">Quant</th>
                    <th data-col="storageBytes" class="num">Storage / 1M docs</th>
                    <th data-col="latency_ms" class="num">Latency</th>
                    <th data-col="accuracy" class="num">Recall@10</th>
                </tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
const ALL_CONFIGS = [{"id": "zembed-1-f32-full", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half", "name": "zembed-1 (\u00bd dim)", "quantization": "float32", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#6366f1"}, {"id": "zembed-1-f32-quarter", "name": "zembed-1 (\u00bc dim)", "quantization": "float32", "matryoshka": "\u00bc", "dims": 512, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.04, "color": "#818cf8"}, {"id": "zembed-1-f32-eighth", "name": "zembed-1 (\u215b dim)", "quantization": "float32", "matryoshka": "\u215b", "dims": 256, "bits_per_dim": 32, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.08, "color": "#a5b4fc"}, {"id": "zembed-1-int8-full", "name": "zembed-1 (int8)", "quantization": "int8", "matryoshka": "full", "dims": 2048, "bits_per_dim": 8, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.005, "color": "#7c3aed"}, {"id": "zembed-1-int8-half", "name": "zembed-1 (\u00bd dim, int8)", "quantization": "int8", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 8, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.02, "color": "#8b5cf6"}, {"id": "zembed-1-bin-full", "name": "zembed-1 (binary)", "quantization": "binary", "matryoshka": "full", "dims": 2048, "bits_per_dim": 1, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.025, "color": "#a78bfa"}, {"id": "zembed-1-bin-half", "name": "zembed-1 (\u00bd dim, binary)", "quantization": "binary", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 1, "deployment": "api", "price_per_m_tokens": 0.06, "latency_ms": 45, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.035, "color": "#c4b5fd"}, {"id": "zembed-1-f32-full-vpc", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half-vpc", "name": "zembed-1 (\u00bd dim)", "quantization": "float32", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 32, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#6366f1"}, {"id": "zembed-1-int8-full-vpc", "name": "zembed-1 (int8)", "quantization": "int8", "matryoshka": "full", "dims": 2048, "bits_per_dim": 8, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.005, "color": "#7c3aed"}, {"id": "zembed-1-bin-half-vpc", "name": "zembed-1 (\u00bd dim, binary)", "quantization": "binary", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 1, "deployment": "vpc", "gpu": "A10G", "price_per_hour": 1.5, "max_tokens_per_sec": 50000, "latency_ms": 35, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.035, "color": "#c4b5fd"}, {"id": "zembed-1-f32-full-vpc-h100", "name": "zembed-1", "quantization": "float32", "matryoshka": "full", "dims": 2048, "bits_per_dim": 32, "deployment": "vpc", "gpu": "H100", "price_per_hour": 4.5, "max_tokens_per_sec": 200000, "latency_ms": 15, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.0, "color": "#4f46e5"}, {"id": "zembed-1-f32-half-vpc-h100", "name": "zembed-1 (\u00bd dim)", "quantization": "float32", "matryoshka": "\u00bd", "dims": 1024, "bits_per_dim": 32, "deployment": "vpc", "gpu": "H100", "price_per_hour": 4.5, "max_tokens_per_sec": 200000, "latency_ms": 15, "checkpoint": "zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450", "accuracy_penalty": 0.015, "color": "#6366f1"}];
const RECALL_CURVES = {"zembed-4b-v0.3.0-mix-v3.0/epoch-001-step-8450": [0.07432, 0.11991, 0.1569, 0.19005, 0.21845, 0.24193, 0.26247, 0.28404, 0.30216, 0.31819, 0.33332, 0.34752, 0.36052, 0.37331, 0.38536, 0.39702, 0.40796, 0.41847, 0.42833, 0.4374, 0.4479, 0.45637, 0.46471, 0.47143, 0.47803, 0.48402, 0.49008, 0.49667, 0.50337, 0.50871, 0.51507, 0.52131, 0.52687, 0.53186, 0.53832, 0.54176, 0.54536, 0.55015, 0.55422, 0.55769, 0.56234, 0.56601, 0.56899, 0.57305, 0.57638, 0.57968, 0.58341, 0.58704, 0.59036, 0.59458, 0.59732, 0.60027, 0.60448, 0.60725, 0.61031, 0.61334, 0.61672, 0.62019, 0.62271, 0.62524, 0.62819, 0.63077, 0.63301, 0.63549, 0.63795, 0.64024, 0.64206, 0.6436, 0.64531, 0.64818, 0.65018, 0.65234, 0.65427, 0.65595, 0.65747, 0.65979, 0.66166, 0.66461, 0.66738, 0.66866, 0.67068, 0.67294, 0.67469, 0.6771, 0.67861, 0.68072, 0.68259, 0.68388, 0.68593, 0.68765, 0.68891, 0.69072, 0.69256, 0.69438, 0.69589, 0.69717, 0.69945, 0.70065, 0.70205, 0.70387], "aimodel-embed/modal/voyage-4.zeroentropy.dev": [0.06552, 0.11047, 0.14713, 0.18214, 0.20847, 0.23352, 0.25545, 0.2778, 0.29755, 0.31541, 0.32955, 0.34344, 0.35488, 0.36702, 0.37848, 0.39, 0.40018, 0.40934, 0.41965, 0.42886, 0.43897, 0.44618, 0.45463, 0.46125, 0.46798, 0.47533, 0.48293, 0.48993, 0.49608, 0.50216, 0.50766, 0.51377, 0.52007, 0.52517, 0.53137, 0.53619, 0.54022, 0.54494, 0.54906, 0.5528, 0.55736, 0.5612, 0.56616, 0.5701, 0.57319, 0.57766, 0.58194, 0.58574, 0.59177, 0.59533, 0.59867, 0.60195, 0.60465, 0.60751, 0.61154, 0.61501, 0.61792, 0.62049, 0.62411, 0.6268, 0.6292, 0.63243, 0.63432, 0.6368, 0.63982, 0.64254, 0.64516, 0.64723, 0.64925, 0.65141, 0.65371, 0.656, 0.65809, 0.65968, 0.66295, 0.66578, 0.66791, 0.66902, 0.67123, 0.67341, 0.67512, 0.67726, 0.68011, 0.68163, 0.68394, 0.68651, 0.68814, 0.69062, 0.69271, 0.69406, 0.69685, 0.69851, 0.69988, 0.70073, 0.7023, 0.70358, 0.70509, 0.70688, 0.7086, 0.70976], "aimodel-embed/modal/zeroentropy--voyage-4-nano-model-endpoint.modal.run": [0.05638, 0.09675, 0.13112, 0.16021, 0.18599, 0.20369, 0.22397, 0.24121, 0.26075, 0.27791, 0.29193, 0.30417, 0.31532, 0.32813, 0.33751, 0.34837, 0.35963, 0.3692, 0.38091, 0.38854, 0.39687, 0.40569, 0.41239, 0.41897, 0.42692, 0.43429, 0.44101, 0.44728, 0.45281, 0.45875, 0.46393, 0.46922, 0.47464, 0.47979, 0.48357, 0.48772, 0.49389, 0.498, 0.50268, 0.50669, 0.51034, 0.51408, 0.51922, 0.52304, 0.52699, 0.53137, 0.53465, 0.53838, 0.54269, 0.54611, 0.5487, 0.55218, 0.55426, 0.55698, 0.55997, 0.56265, 0.5655, 0.56886, 0.57079, 0.57336, 0.5768, 0.57969, 0.58215, 0.58493, 0.58872, 0.59067, 0.59376, 0.59665, 0.59907, 0.60187, 0.60401, 0.60618, 0.60878, 0.61073, 0.61288, 0.615, 0.61718, 0.62007, 0.62258, 0.62486, 0.62695, 0.62867, 0.63128, 0.63338, 0.63581, 0.63738, 0.63931, 0.64115, 0.64202, 0.64346, 0.64533, 0.64695, 0.64859, 0.65007, 0.65156, 0.65318, 0.65467, 0.6567, 0.65802, 0.65975], "aimodel-embed/openai/text-embedding-3-large": [0.05532, 0.09518, 0.129, 0.15517, 0.1812, 0.20393, 0.22331, 0.24021, 0.25679, 0.27221, 0.2849, 0.29719, 0.31016, 0.32124, 0.33188, 0.34084, 0.35038, 0.36152, 0.37167, 0.38108, 0.38965, 0.39687, 0.40391, 0.41159, 0.41788, 0.42556, 0.432, 0.43706, 0.44259, 0.44823, 0.45396, 0.46013, 0.46462, 0.47109, 0.47491, 0.48086, 0.48476, 0.48911, 0.49337, 0.49779, 0.50228, 0.50722, 0.51235, 0.5163, 0.5192, 0.52309, 0.52665, 0.53082, 0.53506, 0.5378, 0.54171, 0.54441, 0.54807, 0.55063, 0.55318, 0.55619, 0.5592, 0.56154, 0.56499, 0.5676, 0.57099, 0.57377, 0.57674, 0.57922, 0.58205, 0.58475, 0.58774, 0.5903, 0.59217, 0.59511, 0.59705, 0.5992, 0.60046, 0.60352, 0.60581, 0.6074, 0.60917, 0.61086, 0.61327, 0.61494, 0.61659, 0.61822, 0.62041, 0.62221, 0.62411, 0.62659, 0.62851, 0.63038, 0.63262, 0.63453, 0.63577, 0.63698, 0.6384, 0.64056, 0.64211, 0.64338, 0.64418, 0.64555, 0.64762, 0.64892], "aimodel-embed/openai/text-embedding-3-small": [0.05151, 0.08477, 0.11496, 0.13818, 0.15794, 0.17541, 0.19028, 0.2078, 0.22551, 0.23862, 0.25051, 0.26262, 0.27486, 0.28456, 0.29497, 0.30403, 0.31223, 0.32165, 0.33063, 0.33895, 0.34642, 0.35292, 0.36058, 0.36648, 0.37338, 0.3785, 0.38443, 0.38978, 0.39519, 0.40102, 0.40625, 0.4118, 0.41791, 0.42192, 0.4269, 0.43143, 0.43509, 0.44027, 0.44571, 0.44948, 0.4536, 0.45679, 0.46053, 0.46442, 0.46803, 0.47084, 0.47447, 0.47794, 0.48129, 0.48477, 0.48774, 0.49114, 0.49541, 0.49827, 0.50135, 0.50404, 0.50718, 0.50942, 0.51144, 0.51341, 0.51588, 0.51775, 0.51942, 0.52245, 0.52522, 0.52687, 0.52903, 0.53198, 0.53416, 0.5364, 0.53918, 0.54167, 0.54366, 0.54623, 0.54847, 0.5503, 0.55218, 0.55402, 0.5554, 0.55704, 0.55932, 0.56151, 0.56352, 0.56528, 0.56747, 0.56988, 0.57274, 0.57414, 0.57644, 0.57815, 0.57944, 0.58158, 0.5836, 0.58476, 0.58689, 0.58874, 0.59046, 0.59338, 0.59558, 0.59779]};
const RECALL_K = 10;

const state = {deploy:null, gpu:null, latency:null, storage:null};
let sortCol = 'accuracy', sortAsc = false;
let chart1 = null, chart2 = null;
let recoId = null;

function getAccuracy(c) {
    if (c.accuracy_override !== undefined) return c.accuracy_override;
    if (c.checkpoint && RECALL_CURVES[c.checkpoint])
        return Math.max(0, RECALL_CURVES[c.checkpoint][RECALL_K - 1] - (c.accuracy_penalty || 0));
    return 0;
}
function storagePerMillion(c) { return 1e6 * c.dims * (c.bits_per_dim / 8); }
function fmtBytes(b) {
    const gb = b / (1024**3);
    if (gb >= 1000) return (gb/1000).toFixed(1) + ' TB';
    if (gb >= 1) return gb.toFixed(1) + ' GB';
    return (gb*1024).toFixed(0) + ' MB';
}

function show(id) { document.getElementById(id).classList.remove('collapsed'); }
function hide(id) { document.getElementById(id).classList.add('collapsed'); }

function pick(key, val) {
    state[key] = val;
    const step = key === 'gpu' ? 'step-gpu' : key === 'deploy' ? 'step-deploy' : key === 'latency' ? 'step-latency' : 'step-storage';
    document.querySelectorAll('#' + step + ' .choice').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    if (key === 'deploy') {
        state.gpu = null; state.latency = null; state.storage = null;
        hide('step-gpu'); hide('step-latency'); hide('step-storage');
        document.getElementById('reco').classList.remove('visible');
        document.getElementById('results').classList.remove('visible');
        document.getElementById('resetBar').classList.remove('visible');
        if (val === 'vpc') {
            document.getElementById('latency-step-num').textContent = 'Step 3 of 4';
            document.getElementById('storage-step-num').textContent = 'Step 4 of 4';
            setTimeout(() => show('step-gpu'), 80);
        } else {
            document.getElementById('latency-step-num').textContent = 'Step 2 of 3';
            document.getElementById('storage-step-num').textContent = 'Step 3 of 3';
            setTimeout(() => show('step-latency'), 80);
        }
    } else if (key === 'gpu') {
        state.latency = null; state.storage = null;
        hide('step-latency'); hide('step-storage');
        document.getElementById('reco').classList.remove('visible');
        document.getElementById('results').classList.remove('visible');
        document.getElementById('resetBar').classList.remove('visible');
        setTimeout(() => show('step-latency'), 80);
    } else if (key === 'latency') {
        state.storage = null;
        hide('step-storage');
        document.getElementById('reco').classList.remove('visible');
        document.getElementById('results').classList.remove('visible');
        document.getElementById('resetBar').classList.remove('visible');
        setTimeout(() => show('step-storage'), 80);
    } else if (key === 'storage') {
        resolve();
    }
}

function getFilteredConfigs() {
    return ALL_CONFIGS.filter(c => {
        if (state.deploy === 'api' && c.deployment !== 'api') return false;
        if (state.deploy === 'vpc' && c.deployment !== 'vpc') return false;
        if (state.deploy === 'vpc' && state.gpu && c.gpu !== state.gpu) return false;
        return true;
    }).map(c => ({...c, accuracy: getAccuracy(c), storageBytes: storagePerMillion(c)}));
}

function meetsLatency(c) {
    if (state.latency === 'tight') return c.latency_ms < 20;
    if (state.latency === 'normal') return c.latency_ms < 50;
    return true;
}

function storageScore(c) {
    if (state.storage === 'min') return -c.storageBytes;
    if (state.storage === 'max') return c.accuracy;
    return c.accuracy - c.storageBytes / 1e12;
}

function resolve() {
    const configs = getFilteredConfigs();
    const eligible = configs.filter(meetsLatency);
    const pool = eligible.length > 0 ? eligible : configs;

    pool.sort((a, b) => {
        if (state.storage === 'min') {
            if (a.storageBytes !== b.storageBytes) return a.storageBytes - b.storageBytes;
            return b.accuracy - a.accuracy;
        }
        if (state.storage === 'max') return b.accuracy - a.accuracy;
        const sa = storageScore(a), sb = storageScore(b);
        return sb - sa;
    });

    const best = pool[0];
    recoId = best.id;

    document.getElementById('recoName').textContent = best.name;
    const qDesc = best.quantization === 'float32' ? 'Full precision' : best.quantization === 'int8' ? '8-bit quantized' : 'Binary quantized';
    const deployDesc = best.deployment === 'api' ? 'ZeroEntropy API' : best.gpu + ' on your VPC';
    document.getElementById('recoSub').textContent = qDesc + ' ¬∑ ' + best.dims + ' dims ¬∑ ' + deployDesc;
    document.getElementById('recoAccuracy').textContent = (best.accuracy * 100).toFixed(1) + '%';
    document.getElementById('recoLatency').textContent = best.latency_ms + 'ms';
    document.getElementById('recoDims').textContent = best.dims.toString();
    document.getElementById('recoStorage').textContent = fmtBytes(best.storageBytes);

    document.getElementById('reco').classList.add('visible');
    document.getElementById('resetBar').classList.add('visible');
    setTimeout(() => {
        document.getElementById('results').classList.add('visible');
        renderTable(configs);
        renderScatters(configs);
    }, 200);
}

function renderScatters(configs) {
    const pts = configs.map(c => ({
        x_storage: c.storageBytes / (1024**3),
        x_lat: c.latency_ms,
        y: c.accuracy,
        label: c.name + ' (' + c.quantization + ')',
        color: c.id === recoId ? c.color : c.color + '66',
        radius: c.id === recoId ? 10 : 6,
        border: c.id === recoId ? '#fff' : 'transparent',
        borderWidth: c.id === recoId ? 3 : 0,
    }));

    const mkOpts = (xLabel) => ({
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 500, easing: 'easeInOutCubic' },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: (item) => {
                        const p = pts[item.dataIndex];
                        return p.label + ': ' + (p.y * 100).toFixed(1) + '%';
                    }
                }
            }
        },
        scales: {
            x: { title: { display: true, text: xLabel, font: { size: 12 } } },
            y: { title: { display: true, text: 'Recall@10', font: { size: 12 } }, min: 0, max: 1 },
        },
    });

    const ds1 = [{ data: pts.map(p => ({x: p.x_storage, y: p.y})), backgroundColor: pts.map(p => p.color), pointRadius: pts.map(p => p.radius), pointBorderColor: pts.map(p => p.border), pointBorderWidth: pts.map(p => p.borderWidth) }];
    const ds2 = [{ data: pts.map(p => ({x: p.x_lat, y: p.y})), backgroundColor: pts.map(p => p.color), pointRadius: pts.map(p => p.radius), pointBorderColor: pts.map(p => p.border), pointBorderWidth: pts.map(p => p.borderWidth) }];

    if (chart1) { chart1.data.datasets = ds1; chart1.options = mkOpts('Storage per 1M docs (GB)'); chart1.update(); }
    else chart1 = new Chart(document.getElementById('scatterStorageAcc'), { type: 'scatter', data: { datasets: ds1 }, options: mkOpts('Storage per 1M docs (GB)') });

    if (chart2) { chart2.data.datasets = ds2; chart2.options = mkOpts('Latency (ms)'); chart2.update(); }
    else chart2 = new Chart(document.getElementById('scatterLatAcc'), { type: 'scatter', data: { datasets: ds2 }, options: mkOpts('Latency (ms)') });
}

function renderTable(configs) {
    const rows = [...configs].sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
        return sortAsc ? (va < vb ? -1 : 1) : (va > vb ? -1 : 1);
    });
    const best = Math.max(...rows.map(r => r.accuracy));
    let html = '';
    for (const r of rows) {
        const isReco = r.id === recoId;
        const cls = isReco ? 'recommended' : '';
        const tag = isReco ? '<span class="tag tag-reco">‚òÖ recommended</span>' : r.accuracy >= best - 0.001 ? '<span class="tag tag-best">best accuracy</span>' : '';
        html += '<tr class="' + cls + '">'
            + '<td><span class="model-dot" style="background:' + r.color + '"></span>' + r.name + tag + '</td>'
            + '<td class="num">' + r.dims + '</td>'
            + '<td>' + r.quantization + '</td>'
            + '<td class="num">' + fmtBytes(r.storageBytes) + '</td>'
            + '<td class="num">' + r.latency_ms + ' ms</td>'
            + '<td class="num">' + (r.accuracy * 100).toFixed(1) + '%</td>'
            + '</tr>';
    }
    document.getElementById('tableBody').innerHTML = html;
}

function resetWizard() {
    state.deploy = null; state.gpu = null; state.latency = null; state.storage = null;
    recoId = null;
    document.querySelectorAll('.choice').forEach(el => el.classList.remove('selected'));
    hide('step-gpu'); hide('step-latency'); hide('step-storage');
    show('step-deploy');
    document.getElementById('reco').classList.remove('visible');
    document.getElementById('results').classList.remove('visible');
    document.getElementById('resetBar').classList.remove('visible');
}

document.querySelectorAll('#resultTable thead th').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = col === 'name' || col === 'quantization'; }
        const configs = getFilteredConfigs();
        renderTable(configs);
    });
});
</script>
</div>
</body>
</html>